import{r as c}from"./vendor-CSLgDR2_.js";import{s as t}from"./index-Bn3Kbo31.js";const x=()=>{const[m,g]=c.useState({totalRevenue:0,totalOrders:0,totalProducts:0,totalCustomers:0,activeCoupons:0,lowStockItems:0}),[h,l]=c.useState([]),[p,i]=c.useState(!0),r=async()=>{i(!0);try{const[{count:e,data:o},{count:s,data:a},{count:n},{count:b},{data:d}]=await Promise.all([t.from("orders").select("total",{count:"exact"}),t.from("products").select("stockQuantity",{count:"exact"}),t.from("users").select("*",{count:"exact",head:!0}),t.from("coupons").select("*",{count:"exact",head:!0}).eq("isActive",!0),t.from("audit_logs").select("*").order("created_at",{ascending:!1}).limit(5)]),f=(o==null?void 0:o.reduce((u,C)=>u+(Number(C.total)||0),0))||0,v=(a==null?void 0:a.filter(u=>u.stockQuantity<10).length)||0;g({totalRevenue:f,totalOrders:e||0,totalProducts:s||0,totalCustomers:n||0,activeCoupons:b||0,lowStockItems:v}),d&&l(d)}catch(e){console.error("Error fetching admin dashboard data:",e)}finally{i(!1)}};return c.useEffect(()=>{r();const e=t.channel("admin-orders").on("postgres_changes",{event:"*",schema:"public",table:"orders"},r).subscribe(),o=t.channel("admin-products").on("postgres_changes",{event:"*",schema:"public",table:"products"},r).subscribe(),s=t.channel("admin-logs").on("postgres_changes",{event:"INSERT",schema:"public",table:"audit_logs"},a=>{l(n=>[a.new,...n].slice(0,5))}).subscribe();return()=>{t.removeChannel(e),t.removeChannel(o),t.removeChannel(s)}},[]),{stats:m,recentLogs:h,loading:p,refetch:r,logAction:async(e,o)=>{const{data:{user:s}}=await t.auth.getUser();s&&await t.from("audit_logs").insert({admin_email:s.email,action:e,details:o})}}};export{x as u};
